# å·¥å…·è°ƒç”¨æ˜¾ç¤ºåŠŸèƒ½ - ä¿®å¤è¯´æ˜

## é—®é¢˜è¯Šæ–­

é€šè¿‡æµ‹è¯•å‘ç°ï¼ŒAgnoæ¡†æ¶è¿”å›çš„ `tool_calls` æ˜¯**å­—å…¸æ ¼å¼**è€Œä¸æ˜¯å¯¹è±¡æ ¼å¼ã€‚

### å·¥å…·è°ƒç”¨æ•°æ®ç»“æ„

```python
# Agno è¿”å›çš„æ ¼å¼
{
  "id": "call_xxx",
  "function": {
    "name": "list_all_tables",
    "arguments": "{}"  # å¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–å­—å…¸
  },
  "type": "function",
  "index": 0
}
```

## å·²ä¿®å¤çš„é—®é¢˜

### 1. åç«¯æå–é€»è¾‘ (`backend/main.py`)

**ä¿®å¤å‰**ï¼šåªå¤„ç†å¯¹è±¡æ ¼å¼
```python
if hasattr(call, 'function'):
    func = call.function
    ...
```

**ä¿®å¤å**ï¼šåŒæ—¶æ”¯æŒå­—å…¸å’Œå¯¹è±¡æ ¼å¼
```python
# å¤„ç†å­—å…¸æ ¼å¼
if isinstance(call, dict) and 'function' in call:
    func_data = call['function']
    func_name = func_data.get('name', '')
    func_args = func_data.get('arguments', {})
    ...

# å¤„ç†å¯¹è±¡æ ¼å¼ï¼ˆå‘åå…¼å®¹ï¼‰
elif hasattr(call, 'function'):
    func = call.function
    ...
```

### 2. å‰ç«¯ç»„ä»¶ (`frontend/src/components/ToolCallsDisplay.jsx`)

**ä¿®å¤å‰**ï¼šä½¿ç”¨ `<Panel>` å­ç»„ä»¶ï¼ˆAntd 4.x è¯­æ³•ï¼‰
```jsx
<Collapse>
  <Panel header={...} key="1">
    ...
  </Panel>
</Collapse>
```

**ä¿®å¤å**ï¼šä½¿ç”¨ `items` å±æ€§ï¼ˆAntd 5.x/6.x è¯­æ³•ï¼‰
```jsx
const collapseItems = [{
  key: '1',
  label: <Space>...</Space>,
  children: <div>...</div>
}]

<Collapse items={collapseItems} />
```

## æµ‹è¯•ç»“æœ

### åç«¯æµ‹è¯•

è¿è¡Œ `test_full_tool_calls_flow.py`ï¼Œç»“æœï¼š

âœ… **æµ‹è¯• #1**: åˆ—å‡ºæ‰€æœ‰è¡¨
- æå–åˆ° 1 ä¸ªå·¥å…·è°ƒç”¨: `list_all_tables`

âœ… **æµ‹è¯• #2**: æŸ¥è¯¢è®°å½•æ•°
- æå–åˆ° 3 ä¸ªå·¥å…·è°ƒç”¨:
  1. `list_all_tables`
  2. `get_table_ddl`
  3. `execute_query_with_explanation`

âœ… **æµ‹è¯• #3**: æŸ¥è¯¢è¡¨ç»“æ„
- æˆåŠŸæå–å·¥å…·è°ƒç”¨ä¿¡æ¯

### å‰ç«¯æµ‹è¯•

éœ€è¦å¯åŠ¨å‰ç«¯æœåŠ¡è¿›è¡Œæµ‹è¯•ï¼š

```bash
cd frontend
npm run dev
```

ç„¶ååœ¨æµè§ˆå™¨ä¸­æµ‹è¯•ï¼š
1. ç™»å½•ç³»ç»Ÿ
2. å‘é€æŸ¥è¯¢ï¼š"åˆ—å‡ºæ‰€æœ‰è¡¨"
3. æŸ¥çœ‹AIå›å¤ä¸‹æ–¹æ˜¯å¦æ˜¾ç¤ºå·¥å…·è°ƒç”¨ä¿¡æ¯

## é¢„æœŸæ•ˆæœ

å½“AIå›å¤æ—¶ï¼Œæ¶ˆæ¯ä¸‹æ–¹ä¼šæ˜¾ç¤ºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¤– æ•°æ®åº“ä¸­å…±æœ‰ä»¥ä¸‹ 6 ä¸ªè¡¨ï¼š...     â”‚
â”‚                                     â”‚
â”‚ â–¼ è°ƒç”¨äº† 1 ä¸ªå·¥å…·                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚ ğŸ”§ å·¥å…· 1: åˆ—å‡ºæ‰€æœ‰è¡¨      â”‚     â”‚
â”‚   â”‚ è°ƒç”¨å‚æ•°: (æ— )             â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¦‚ä½•éªŒè¯

### æ–¹æ³• 1: æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)ï¼Œåœ¨ Console ä¸­æŸ¥çœ‹ï¼š
- ç½‘ç»œè¯·æ±‚ (Network) ä¸­ `/api/protected/chat` çš„å“åº”
- åº”è¯¥åŒ…å« `tool_calls` å­—æ®µ

### æ–¹æ³• 2: æŸ¥çœ‹å‰ç«¯çŠ¶æ€

åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼š
```javascript
// æŸ¥çœ‹å½“å‰æ¶ˆæ¯
const messages = useChatStore.getState().messages
console.log(messages)

// æŸ¥çœ‹æœ€æ–°æ¶ˆæ¯çš„å·¥å…·è°ƒç”¨
const currentSessionId = useChatStore.getState().currentSessionId
const currentMessages = messages[currentSessionId]
const lastMessage = currentMessages[currentMessages.length - 1]
console.log('Tool calls:', lastMessage.toolCalls)
```

### æ–¹æ³• 3: åç«¯æ—¥å¿—

æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œåº”è¯¥èƒ½çœ‹åˆ°å·¥å…·è°ƒç”¨ä¿¡æ¯è¢«æ­£ç¡®æå–ã€‚

## æ•…éšœæ’æŸ¥

å¦‚æœå·¥å…·è°ƒç”¨ä¿¡æ¯ä»ç„¶ä¸æ˜¾ç¤ºï¼š

### 1. æ£€æŸ¥åç«¯å“åº”

```bash
# æµ‹è¯•åç«¯API
curl -X POST http://localhost:8000/api/protected/chat \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"message": "åˆ—å‡ºæ‰€æœ‰è¡¨", "session_id": "test"}'
```

å“åº”åº”è¯¥åŒ…å« `tool_calls` å­—æ®µã€‚

### 2. æ£€æŸ¥å‰ç«¯ç»„ä»¶å¯¼å…¥

ç¡®è®¤ `ChatArea.jsx` æ­£ç¡®å¯¼å…¥äº† `ToolCallsDisplay`ï¼š
```jsx
import { ToolCallsDisplay } from './ToolCallsDisplay'
```

### 3. æ£€æŸ¥æ¶ˆæ¯æ•°æ®

åœ¨ `ChatArea.jsx` ä¸­æ·»åŠ è°ƒè¯•ä»£ç ï¼š
```jsx
{message.type === 'assistant' && (
  <>
    <StreamingMarkdown content={message.content} />
    {console.log('Tool calls:', message.toolCalls)}
    {message.toolCalls && message.toolCalls.length > 0 && (
      <ToolCallsDisplay toolCalls={message.toolCalls} />
    )}
  </>
)}
```

### 4. æ£€æŸ¥Antdç‰ˆæœ¬

ç¡®è®¤ä½¿ç”¨çš„æ˜¯ Antd 6.xï¼š
```bash
cd frontend
npm list antd
```

åº”è¯¥æ˜¾ç¤º `antd@6.1.2` æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚

## ç›¸å…³æ–‡ä»¶

- `backend/main.py` - åç«¯å·¥å…·è°ƒç”¨æå–é€»è¾‘
- `frontend/src/components/ToolCallsDisplay.jsx` - å·¥å…·è°ƒç”¨å±•ç¤ºç»„ä»¶
- `frontend/src/components/ChatArea.jsx` - èŠå¤©ç•Œé¢é›†æˆ
- `frontend/src/store/useChatStore.js` - å‰ç«¯çŠ¶æ€ç®¡ç†
- `test_tool_calls_extraction.py` - å·¥å…·è°ƒç”¨æå–æµ‹è¯•
- `test_full_tool_calls_flow.py` - å®Œæ•´æµç¨‹æµ‹è¯•

## ä¸‹ä¸€æ­¥

1. å¯åŠ¨å‰ç«¯æœåŠ¡æµ‹è¯•å®é™…æ•ˆæœ
2. å¦‚æœæœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯
3. æ ¹æ®é”™è¯¯ä¿¡æ¯è¿›è¡Œè¿›ä¸€æ­¥è°ƒè¯•


