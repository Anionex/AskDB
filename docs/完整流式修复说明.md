# å®Œæ•´æµå¼ä¿®å¤è¯´æ˜ - å‰åç«¯éƒ½éœ€è¦ä¿®æ”¹

## é—®é¢˜æ€»ç»“

1. **åç«¯é—®é¢˜**: ç¼ºå°‘ `stream_events=True` å‚æ•°ï¼Œæ— æ³•æ¥æ”¶å·¥å…·è°ƒç”¨äº‹ä»¶
2. **å‰ç«¯é—®é¢˜**: ä½¿ç”¨çš„æ˜¯æ™®é€š POST æ¥å£ï¼Œæ ¹æœ¬æ²¡æœ‰ä½¿ç”¨æµå¼æ¥å£

## å¿…é¡»çš„ä¿®æ”¹

### âœ… åç«¯ä¿®æ”¹ï¼ˆbackend/main.pyï¼‰

**ä½ç½®**: `process_chat_message_stream` å‡½æ•°ï¼ˆç¬¬ 569 è¡Œå·¦å³ï¼‰

**å…³é”®ä¿®æ”¹**:
```python
# âŒ æ—§ä»£ç ï¼ˆç¼ºå°‘ stream_events=Trueï¼‰
stream = agent.run(message, stream=True)

# âœ… æ–°ä»£ç ï¼ˆæ·»åŠ  stream_events=Trueï¼‰
stream = agent.run(message, stream=True, stream_events=True)
                                        ^^^^^^^^^^^^^^^^^^
                                        å…³é”®å‚æ•°ï¼
```

**äº‹ä»¶å¤„ç†**:
```python
from agno.agent import RunEvent

for chunk in stream:
    if chunk.event == RunEvent.run_content:
        # å†…å®¹äº‹ä»¶
        yield f"data: {json.dumps({'type': 'content', 'content': chunk.content})}\n\n"
        
    elif chunk.event == RunEvent.tool_call_started:
        # å·¥å…·è°ƒç”¨å¼€å§‹
        yield f"data: {json.dumps({'type': 'tool_call_start', 'data': {...}})}\n\n"
        
    elif chunk.event == RunEvent.tool_call_completed:
        # å·¥å…·è°ƒç”¨å®Œæˆ
        yield f"data: {json.dumps({'type': 'tool_call_result', 'data': {...}})}\n\n"
```

### âœ… å‰ç«¯ä¿®æ”¹ï¼ˆfrontend/src/store/useChatStore.jsï¼‰

**ä½ç½®**: `sendMessage` å‡½æ•°ï¼ˆç¬¬ 190 è¡Œå·¦å³ï¼‰

**ä¸»è¦å˜æ›´**:

#### 1. æ”¹ç”¨æµå¼æ¥å£

```javascript
// âŒ æ—§ä»£ç  - æ™®é€š POST è¯·æ±‚
const response = await axios.post(
  `${API_BASE}/protected/chat`,
  { message: content, session_id: sessionId }
)

// âœ… æ–°ä»£ç  - æµå¼ GET è¯·æ±‚
const url = `${API_BASE}/protected/chat/stream?message=${encodeURIComponent(content)}&session_id=${sessionId}`
const response = await fetch(url, {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Accept': 'text/event-stream'
  }
})
```

#### 2. å¤„ç† SSE æµå¼äº‹ä»¶

```javascript
const reader = response.body.getReader()
const decoder = new TextDecoder()
let buffer = ''

while (true) {
  const { done, value } = await reader.read()
  if (done) break

  buffer += decoder.decode(value, { stream: true })
  const lines = buffer.split('\n')
  buffer = lines.pop() || ''

  for (const line of lines) {
    if (line.startsWith('data: ')) {
      const data = JSON.parse(line.slice(6))
      
      if (data.type === 'content') {
        // æµå¼è¿½åŠ å†…å®¹
        get().updateLastMessage({
          content: (lastMessage.content || '') + data.content
        })
      }
      else if (data.type === 'tool_call_start') {
        // å·¥å…·è°ƒç”¨å¼€å§‹ - ç«‹å³æ·»åŠ 
        get().addToolCallToLastMessage({
          name: data.data.name,
          arguments: data.data.arguments,
          result: null
        })
      }
      else if (data.type === 'tool_call_result') {
        // å·¥å…·è°ƒç”¨å®Œæˆ - æ›´æ–°ç»“æœ
        updatedToolCalls[i].result = data.data.result
      }
    }
  }
}
```

## æ•°æ®æµå›¾

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â†“
å‰ç«¯: fetch('/api/protected/chat/stream')  â† ä½¿ç”¨æµå¼æ¥å£
    â†“
åç«¯: agent.run(message, stream=True, stream_events=True)  â† å…³é”®å‚æ•°
    â†“
Agno ç”Ÿæˆæµå¼äº‹ä»¶:
    â”œâ”€ RunEvent.tool_call_started
    â”œâ”€ RunEvent.tool_call_completed
    â””â”€ RunEvent.run_content (å¤šæ¬¡)
    â†“
åç«¯: è½¬æ¢ä¸º SSE äº‹ä»¶
    â”œâ”€ type: 'tool_call_start'
    â”œâ”€ type: 'tool_call_result'
    â””â”€ type: 'content'
    â†“
å‰ç«¯: ReadableStream æ¥æ”¶å¹¶å¤„ç†
    â”œâ”€ tool_call_start â†’ ç«‹å³æ˜¾ç¤ºå·¥å…·è°ƒç”¨
    â”œâ”€ tool_call_result â†’ æ›´æ–°å·¥å…·ç»“æœ
    â””â”€ content â†’ é€å­—æ˜¾ç¤ºå†…å®¹
    â†“
UI å®æ—¶æ›´æ–°
```

## é‡å¯æ­¥éª¤

### 1. é‡å¯åç«¯ï¼ˆå¿…é¡»ï¼ï¼‰

```bash
# Ctrl+C åœæ­¢å½“å‰åç«¯

# é‡æ–°å¯åŠ¨
uv run python start_backend.py
```

### 2. é‡å¯å‰ç«¯ï¼ˆå¿…é¡»ï¼ï¼‰

```bash
# Ctrl+C åœæ­¢å½“å‰å‰ç«¯

# é‡æ–°å¯åŠ¨
cd frontend
npm run dev
```

**ä¸ºä»€ä¹ˆéƒ½è¦é‡å¯ï¼Ÿ**
- åç«¯ï¼šä»£ç ä¿®æ”¹éœ€è¦é‡æ–°åŠ è½½
- å‰ç«¯ï¼šè™½ç„¶ Vite æœ‰çƒ­é‡è½½ï¼Œä½† Store ä¿®æ”¹é€šå¸¸éœ€è¦å®Œå…¨é‡å¯

## æµ‹è¯•éªŒè¯

### æ–¹æ³•1: å‘½ä»¤è¡Œæµ‹è¯•

```bash
uv run python test_streaming_fix.py
```

é¢„æœŸè¾“å‡º:
```
[TOOL_START] list_all_tables
[TOOL_DONE] list_all_tables
[SUCCESS] æµå¼å®ç°ä¿®å¤æˆåŠŸï¼
```

### æ–¹æ³•2: æµè§ˆå™¨æµ‹è¯•

1. ç¡®ä¿å‰åç«¯éƒ½å·²é‡å¯
2. è®¿é—® http://localhost:5173
3. ç™»å½•ç³»ç»Ÿ
4. å‘é€æŸ¥è¯¢: "åˆ—å‡ºæ‰€æœ‰æ•°æ®åº“è¡¨"

#### âœ… åº”è¯¥çœ‹åˆ°:

1. **AI å›å¤é€å­—æ˜¾ç¤º**ï¼ˆçœŸæ­£çš„æµå¼ï¼‰
   ```
   æ•°æ®åº“ä¸­åŒ…å«ä»¥ä¸‹è¡¨æ ¼ï¼š...
   ï¼ˆä¸€ä¸ªå­—ä¸€ä¸ªå­—å‡ºç°ï¼‰
   ```

2. **å·¥å…·è°ƒç”¨å®æ—¶æ˜¾ç¤º**ï¼ˆåœ¨å›å¤ä¸‹æ–¹ï¼‰
   ```
   â–¼ è°ƒç”¨äº† 1 ä¸ªå·¥å…·
     ğŸ”§ å·¥å…· 1: åˆ—å‡ºæ‰€æœ‰è¡¨
     è°ƒç”¨å‚æ•°: {}
     è¿”å›ç»“æœ: {...}
   ```

3. **å·¥å…·è°ƒç”¨è¿‡ç¨‹**:
   - å·¥å…·å¼€å§‹è°ƒç”¨æ—¶ï¼Œç«‹å³æ˜¾ç¤ºï¼ˆresult ä¸ºç©ºï¼‰
   - å·¥å…·å®Œæˆæ—¶ï¼Œç»“æœç«‹å³å¡«å……

### æ–¹æ³•3: ç½‘ç»œè°ƒè¯•

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰â†’ Network:

1. æ‰¾åˆ° `/api/protected/chat/stream` è¯·æ±‚
2. æŸ¥çœ‹ Response:

```
data: {"type":"tool_call_start","data":{...}}

data: {"type":"tool_call_result","data":{...}}

data: {"type":"content","content":"æ•°æ®åº“"}

data: {"type":"content","content":"ä¸­åŒ…å«"}

data: {"type":"done"}
```

âœ… å¿…é¡»çœ‹åˆ° `tool_call_start` å’Œ `tool_call_result` äº‹ä»¶ï¼

## å¸¸è§é—®é¢˜

### Q: ä¿®æ”¹åè¿˜æ˜¯ä¸æ˜¾ç¤ºå·¥å…·è°ƒç”¨ï¼Ÿ

**A**: æ£€æŸ¥æ¸…å•:
- [ ] åç«¯æ˜¯å¦å·²é‡å¯ï¼Ÿ
- [ ] å‰ç«¯æ˜¯å¦å·²é‡å¯ï¼Ÿ
- [ ] æµè§ˆå™¨æ˜¯å¦æ¸…é™¤ç¼“å­˜ï¼Ÿï¼ˆCtrl+Shift+Rï¼‰
- [ ] Network ä¸­æ˜¯å¦çœ‹åˆ° `/stream` è¯·æ±‚ï¼Ÿ
- [ ] Network Response ä¸­æ˜¯å¦æœ‰ `tool_call_start` äº‹ä»¶ï¼Ÿ

### Q: å‰ç«¯æŠ¥é”™ "fetch is not defined"ï¼Ÿ

**A**: è¿™ä¸åº”è¯¥å‘ç”Ÿï¼ˆç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒï¼‰ã€‚å¦‚æœå‡ºç°ï¼Œæ£€æŸ¥æµè§ˆå™¨ç‰ˆæœ¬ã€‚

### Q: å†…å®¹è¿˜æ˜¯ä¸€æ¬¡æ€§å‡ºç°ï¼Ÿ

**A**: æ£€æŸ¥ï¼š
1. Network ä¸­æ˜¯å¦çœŸçš„æ˜¯ `stream` æ¥å£ï¼ˆä¸æ˜¯ `chat` æ¥å£ï¼‰
2. Response ä¸­æ˜¯å¦æœ‰å¤šä¸ª `content` äº‹ä»¶
3. å‰ç«¯æ˜¯å¦æ­£ç¡®å¤„ç†äº†æµå¼è¿½åŠ 

### Q: å·¥å…·è°ƒç”¨æ˜¾ç¤ºä½†æ²¡æœ‰ç»“æœï¼Ÿ

**A**: æ£€æŸ¥ï¼š
1. Network Response ä¸­æ˜¯å¦æœ‰ `tool_call_result` äº‹ä»¶
2. å‰ç«¯æ˜¯å¦æ­£ç¡®æ›´æ–°äº† result å­—æ®µ
3. åç«¯æ˜¯å¦æ­£ç¡®å¤„ç†äº† `tool_call_completed` äº‹ä»¶

## æŠ€æœ¯è¦ç‚¹

### åç«¯å…³é”®ç‚¹

1. **å¿…é¡»ä½¿ç”¨ `stream_events=True`**
   - åªè®¾ç½® `stream=True` åªä¼šè¿”å›å†…å®¹
   - `stream_events=True` æ‰ä¼šè¿”å›å·¥å…·è°ƒç”¨äº‹ä»¶

2. **ä½¿ç”¨äº‹ä»¶æšä¸¾æ£€æŸ¥**
   ```python
   if chunk.event == RunEvent.tool_call_started:  # âœ… æ¨è
   if isinstance(chunk, ToolCallStartedEvent):     # âŒ ä¸æ¨è
   ```

3. **è®¿é—® chunk å±æ€§**
   ```python
   chunk.tool.tool_name    # å·¥å…·åç§°
   chunk.tool.tool_args    # å·¥å…·å‚æ•°
   chunk.tool.result       # å·¥å…·ç»“æœ
   ```

### å‰ç«¯å…³é”®ç‚¹

1. **ä½¿ç”¨ fetch è€Œä¸æ˜¯ axios**
   - axios å¯¹ SSE æ”¯æŒä¸å¥½
   - fetch + ReadableStream æ˜¯æ ‡å‡†åšæ³•

2. **é€è¡Œè§£æ SSE**
   ```javascript
   buffer += decoder.decode(value, { stream: true })
   const lines = buffer.split('\n')
   buffer = lines.pop() || ''  // ä¿ç•™ä¸å®Œæ•´çš„è¡Œ
   ```

3. **åˆ›å»ºç©ºæ¶ˆæ¯ç”¨äºæµå¼æ›´æ–°**
   ```javascript
   // å…ˆåˆ›å»ºç©ºæ¶ˆæ¯
   get().addMessage({ content: '', toolCalls: [] })
   
   // ç„¶åé€æ­¥æ›´æ–°
   get().updateLastMessage({ content: ... })
   get().addToolCallToLastMessage({ ... })
   ```

## éªŒæ”¶æ ‡å‡†

è¿è¡Œæµè§ˆå™¨æµ‹è¯•åï¼Œå¿…é¡»æ»¡è¶³ï¼š

- âœ… AI å›å¤é€å­—æ˜¾ç¤ºï¼ˆçœŸæ­£çš„æµå¼ï¼‰
- âœ… å·¥å…·è°ƒç”¨ç«‹å³æ˜¾ç¤ºï¼ˆä¸ç­‰å¾…å®Œæˆï¼‰
- âœ… å·¥å…·è°ƒç”¨æœ‰å®Œæ•´çš„å‚æ•°å’Œç»“æœ
- âœ… å¤šä¸ªå·¥å…·è°ƒç”¨æŒ‰é¡ºåºæ˜¾ç¤º
- âœ… å†å²æ¶ˆæ¯çš„å·¥å…·è°ƒç”¨æ­£ç¡®æ˜¾ç¤º
- âœ… æ— æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯
- âœ… Network ä¸­çœ‹åˆ° `tool_call_start` äº‹ä»¶

## æ€§èƒ½å¯¹æ¯”

| ç‰¹æ€§ | ä¿®å¤å‰ | ä¿®å¤å |
|-----|-------|--------|
| å“åº”æ–¹å¼ | æ™®é€š POST | æµå¼ SSE |
| é¦–å­—æ˜¾ç¤º | 3-10ç§’å | å³æ—¶ |
| å·¥å…·è°ƒç”¨ | ä¸€æ¬¡æ€§å‡ºç°/ä¸æ˜¾ç¤º | å®æ—¶æ˜¾ç¤º |
| å†…å®¹æ˜¾ç¤º | ä¸€æ¬¡æ€§ | é€å­—æµå¼ |
| ç”¨æˆ·ä½“éªŒ | å·® | ä¼˜ç§€ |

## æ€»ç»“

### å¿…é¡»ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… **backend/main.py** - æ·»åŠ  `stream_events=True`
2. âœ… **frontend/src/store/useChatStore.js** - æ”¹ç”¨æµå¼æ¥å£

### å¿…é¡»é‡å¯çš„æœåŠ¡

1. âœ… åç«¯æœåŠ¡
2. âœ… å‰ç«¯æœåŠ¡

### éªŒè¯æ–¹æ³•

1. âœ… å‘½ä»¤è¡Œæµ‹è¯•è„šæœ¬
2. âœ… æµè§ˆå™¨åŠŸèƒ½æµ‹è¯•
3. âœ… Network ç½‘ç»œè°ƒè¯•

**éƒ½å®Œæˆåï¼Œç³»ç»Ÿå°†å®ç°çœŸæ­£çš„æµå¼å¯¹è¯å’Œå·¥å…·è°ƒç”¨æ˜¾ç¤ºï¼**

---

**æ›´æ–°æ—¥æœŸ**: 2025-12-28  
**çŠ¶æ€**: âœ… å‰åç«¯ä¿®å¤å®Œæˆ  
**ä¸‹ä¸€æ­¥**: é‡å¯æœåŠ¡å¹¶æµ‹è¯•

