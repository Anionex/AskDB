# å·¥å…·è°ƒç”¨æ˜¾ç¤ºåŠŸèƒ½ - æ”¹è¿›è¯´æ˜

## æ”¹è¿› 1: æ˜¾ç¤ºå·¥å…·è¿”å›ç»“æœ âœ…

### åç«¯æ”¹è¿› (`backend/main.py`)

ç°åœ¨ä¼šæå–å·¥å…·çš„è¿”å›ç»“æœï¼Œå¹¶ä¸å·¥å…·è°ƒç”¨åŒ¹é…ï¼š

```python
tool_calls = [{
  'name': 'list_all_tables',
  'arguments': {},
  'result': 'coursestats, coursestats2, teachers, choices, courses, students'  # æ–°å¢
}]
```

**å®ç°é€»è¾‘**ï¼š
1. éå† `response.messages`ï¼Œæ‰¾åˆ° `role='tool'` çš„æ¶ˆæ¯
2. é€šè¿‡ `tool_call_id` åŒ¹é…åˆ°å¯¹åº”çš„å·¥å…·è°ƒç”¨
3. å°†è¿”å›ç»“æœæ·»åŠ åˆ° `result` å­—æ®µ

### å‰ç«¯æ”¹è¿› (`frontend/src/components/ToolCallsDisplay.jsx`)

æ–°å¢è¿”å›ç»“æœæ˜¾ç¤ºåŒºåŸŸï¼š

```jsx
{call.result && (
  <div style={{ 
    maxHeight: '200px',
    overflowY: 'auto',  // å¯ä¸Šä¸‹æ»šåŠ¨
    overflowX: 'auto'   // å¯å·¦å³æ»šåŠ¨
  }}>
    <Text code>{call.result}</Text>
  </div>
)}
```

**ç‰¹æ€§**ï¼š
- âœ… ç»¿è‰²èƒŒæ™¯ï¼ŒåŒºåˆ†å‚æ•°å’Œç»“æœ
- âœ… æœ€å¤§é«˜åº¦ 200pxï¼Œè¶…å‡ºå¯æ»šåŠ¨
- âœ… é•¿ç»“æœè‡ªåŠ¨æˆªæ–­ï¼ˆè¶…è¿‡500å­—ç¬¦ï¼‰
- âœ… ä¿ç•™æ ¼å¼ï¼ˆä½¿ç”¨ `pre-wrap`ï¼‰

### æ•ˆæœå±•ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ å·¥å…· 1: åˆ—å‡ºæ‰€æœ‰è¡¨                â”‚
â”‚                                     â”‚
â”‚ è°ƒç”¨å‚æ•°:                            â”‚
â”‚   (æ— )                              â”‚
â”‚                                     â”‚
â”‚ è¿”å›ç»“æœ: â†•ï¸ (å¯æ»šåŠ¨)                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ coursestats                 â”‚     â”‚
â”‚ â”‚ coursestats2                â”‚     â”‚
â”‚ â”‚ teachers                    â”‚     â”‚
â”‚ â”‚ choices                     â”‚     â”‚
â”‚ â”‚ courses                     â”‚     â”‚
â”‚ â”‚ students                    â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ”¹è¿› 2: æµå¼æ˜¾ç¤ºå·¥å…·è°ƒç”¨ ğŸš§ (å¾…å®ç°)

### å½“å‰é—®é¢˜

ç°åœ¨çš„å®ç°æ˜¯**éæµå¼**çš„ï¼š
1. ç”¨æˆ·å‘é€æ¶ˆæ¯
2. åç«¯å®Œæ•´æ‰§è¡Œï¼ˆå¯èƒ½è°ƒç”¨å¤šä¸ªå·¥å…·ï¼‰
3. è¿”å›æœ€ç»ˆç»“æœ + æ‰€æœ‰å·¥å…·è°ƒç”¨æ±‡æ€»
4. å‰ç«¯ä¸€æ¬¡æ€§æ˜¾ç¤º

**ç”¨æˆ·ä½“éªŒé—®é¢˜**ï¼š
- ç­‰å¾…æ—¶é—´é•¿ï¼Œä¸çŸ¥é“AIåœ¨åšä»€ä¹ˆ
- æ— æ³•å®æ—¶çœ‹åˆ°å·¥å…·è°ƒç”¨è¿‡ç¨‹

### ç†æƒ³æ•ˆæœï¼ˆæµå¼ï¼‰

```
ç”¨æˆ·: æŸ¥è¯¢studentsè¡¨æœ‰å¤šå°‘æ¡è®°å½•

AI: æ­£åœ¨æ€è€ƒ...

ğŸ”§ [å®æ—¶] å·¥å…· 1: åˆ—å‡ºæ‰€æœ‰è¡¨
   å‚æ•°: (æ— )
   ç»“æœ: coursestats, coursestats2, teachers...

ğŸ”§ [å®æ—¶] å·¥å…· 2: è·å–è¡¨ç»“æ„  
   å‚æ•°: table_names: students
   ç»“æœ: CREATE TABLE students (...)

ğŸ”§ [å®æ—¶] å·¥å…· 3: æ‰§è¡ŒæŸ¥è¯¢
   å‚æ•°: 
     sql_query: SELECT COUNT(*) FROM students
     explanation: æŸ¥è¯¢è®°å½•æ•°
   ç»“æœ: 13

AI: studentsè¡¨ä¸­æœ‰13æ¡è®°å½•ã€‚
```

### å®ç°æ–¹æ¡ˆ

#### æ–¹æ¡ˆ A: ä½¿ç”¨ Server-Sent Events (SSE) âœ… æ¨è

åç«¯å·²ç»æœ‰æµå¼æ¥å£ï¼š`/api/protected/chat/stream`

**éœ€è¦ä¿®æ”¹**ï¼š

1. **åç«¯** (`backend/main.py`):
```python
async def process_chat_message_stream(message: str, session_id: str, ...):
    # åœ¨å·¥å…·è°ƒç”¨æ—¶å‘é€äº‹ä»¶
    yield f"data: {json.dumps({'type': 'tool_call', 'data': {...}})}\n\n"
    
    # åœ¨å·¥å…·è¿”å›æ—¶å‘é€äº‹ä»¶
    yield f"data: {json.dumps({'type': 'tool_result', 'data': {...}})}\n\n"
    
    # åœ¨å†…å®¹ç”Ÿæˆæ—¶å‘é€äº‹ä»¶
    yield f"data: {json.dumps({'type': 'content', 'content': chunk})}\n\n"
```

2. **å‰ç«¯** (`frontend/src/store/useChatStore.js`):
```javascript
sendMessageStream: async (content) => {
  const response = await fetch(`${API_BASE}/protected/chat/stream?...`)
  const reader = response.body.getReader()
  
  while (true) {
    const { done, value } = await reader.read()
    if (done) break
    
    const event = parseSSE(value)
    
    if (event.type === 'tool_call') {
      get().addToolCallToLastMessage(event.data)
    } else if (event.type === 'tool_result') {
      get().updateLastToolCallResult(event.data)
    } else if (event.type === 'content') {
      get().updateLastMessage({ content: ... })
    }
  }
}
```

#### æ–¹æ¡ˆ B: ä½¿ç”¨ WebSocket

æ›´å¤æ‚ï¼Œä½†æ›´çµæ´»ã€‚é€‚åˆéœ€è¦åŒå‘é€šä¿¡çš„åœºæ™¯ã€‚

### å®ç°æ­¥éª¤

1. **ä¿®æ”¹ Agno Agent é…ç½®**
   - å¯ç”¨æµå¼è¾“å‡º
   - æ•è·å·¥å…·è°ƒç”¨äº‹ä»¶

2. **ä¿®æ”¹åç«¯æµå¼å¤„ç†**
   - ç›‘å¬å·¥å…·è°ƒç”¨äº‹ä»¶
   - å®æ—¶å‘é€ SSE äº‹ä»¶

3. **ä¿®æ”¹å‰ç«¯**
   - ä½¿ç”¨ EventSource æˆ– fetch æ¥æ”¶ SSE
   - å®æ—¶æ›´æ–° UI

4. **æµ‹è¯•**
   - ç¡®ä¿å·¥å…·è°ƒç”¨é¡ºåºæ­£ç¡®
   - å¤„ç†é”™è¯¯æƒ…å†µ

### æŠ€æœ¯æŒ‘æˆ˜

1. **Agno æ¡†æ¶æ”¯æŒ**
   - éœ€è¦ç¡®è®¤ Agno æ˜¯å¦æ”¯æŒæµå¼å·¥å…·è°ƒç”¨äº‹ä»¶
   - å¯èƒ½éœ€è¦è‡ªå®šä¹‰å·¥å…·åŒ…è£…å™¨

2. **çŠ¶æ€åŒæ­¥**
   - å‰ç«¯éœ€è¦æ­£ç¡®ç»´æŠ¤å·¥å…·è°ƒç”¨çŠ¶æ€
   - å¤„ç†ç½‘ç»œä¸­æ–­ã€é‡è¿ç­‰æƒ…å†µ

3. **æ€§èƒ½ä¼˜åŒ–**
   - é¿å…é¢‘ç¹çš„ UI æ›´æ–°
   - ä½¿ç”¨é˜²æŠ–/èŠ‚æµ

---

## å½“å‰çŠ¶æ€æ€»ç»“

### âœ… å·²å®Œæˆ
1. å·¥å…·è¿”å›ç»“æœæ˜¾ç¤º
2. å¯æ»šåŠ¨åŒºåŸŸ
3. ç»“æœæ ¼å¼åŒ–

### ğŸš§ å¾…å®ç°
1. æµå¼æ˜¾ç¤ºå·¥å…·è°ƒç”¨
2. å®æ—¶æ›´æ–°å·¥å…·çŠ¶æ€
3. å·¥å…·è°ƒç”¨è¿›åº¦æŒ‡ç¤º

---

## å¿«é€Ÿæµ‹è¯•

### æµ‹è¯•è¿”å›ç»“æœæ˜¾ç¤º

1. é‡å¯åç«¯å’Œå‰ç«¯
2. å‘é€æŸ¥è¯¢ï¼š"åˆ—å‡ºæ‰€æœ‰è¡¨"
3. æŸ¥çœ‹å·¥å…·è°ƒç”¨åŒºåŸŸï¼Œåº”è¯¥æ˜¾ç¤ºï¼š
   - å·¥å…·åç§°
   - è°ƒç”¨å‚æ•°
   - **è¿”å›ç»“æœ**ï¼ˆæ–°å¢ï¼Œç»¿è‰²èƒŒæ™¯ï¼‰

### é¢„æœŸæ•ˆæœ

å¦‚æœè¿”å›ç»“æœå¾ˆé•¿ï¼ˆå¦‚è¡¨ç»“æ„ï¼‰ï¼Œåº”è¯¥ï¼š
- æ˜¾ç¤ºåœ¨å¯æ»šåŠ¨åŒºåŸŸå†…
- æœ€å¤§é«˜åº¦ 200px
- è¶…è¿‡ 500 å­—ç¬¦è‡ªåŠ¨æˆªæ–­

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

å¦‚æœä½ éœ€è¦æµå¼æ˜¾ç¤ºï¼Œæˆ‘å¯ä»¥ç»§ç»­å®ç°ï¼š

1. **æ£€æŸ¥ Agno æµå¼æ”¯æŒ**
   - æŸ¥çœ‹ Agno æ–‡æ¡£
   - æµ‹è¯•æµå¼ API

2. **å®ç°åç«¯æµå¼äº‹ä»¶**
   - ä¿®æ”¹ `process_chat_message_stream`
   - æ·»åŠ å·¥å…·è°ƒç”¨äº‹ä»¶

3. **å®ç°å‰ç«¯ SSE æ¥æ”¶**
   - åˆ›å»º `sendMessageStream` æ–¹æ³•
   - å®æ—¶æ›´æ–° UI

ä½ æƒ³è¦æˆ‘ç»§ç»­å®ç°æµå¼æ˜¾ç¤ºå—ï¼Ÿè¿˜æ˜¯å…ˆæµ‹è¯•ä¸€ä¸‹è¿”å›ç»“æœæ˜¾ç¤ºçš„æ•ˆæœï¼Ÿ


