# 数据脱敏与行级权限控制功能说明

## 功能概述

AskDB 实现了动态数据脱敏与行级权限控制功能，无论用户如何查询，系统都能自动施加预设的数据安全策略。

## 核心特性

### 1. 基于角色的权限控制
- **admin**: 能看到所有信息，无任何限制
- **teach开头的用户**: 
  - 能看到所有 students 表数据
  - 只能看到 teacher 表中自己的信息（tid 和用户名一致）
  - 只能看到 choices 表中和他有关的记录（tid 和用户名一致）
- **stu开头的用户**:
  - 只能看到 students 表中自己的信息（sid 和用户名一致）
  - 只能看到 choices 表中和他有关的记录（sid 和用户名一致）
  - 不能访问 teacher 表

### 2. 透明的SQL转换
系统会自动在SQL执行前添加权限过滤条件，用户无需关心权限逻辑。

#### 示例

**学生用户查询**
```sql
-- 原始SQL
SELECT * FROM students

-- 自动转换为（用户名为 stu001）
SELECT * FROM students WHERE (sid = 'stu001')
```

**教师用户查询**
```sql
-- 原始SQL
SELECT * FROM choices WHERE course_id = 'CS101'

-- 自动转换为（用户名为 teach001）
SELECT * FROM choices WHERE (course_id = 'CS101') AND (tid = 'teach001')
```

**复杂查询也会被正确处理**
```sql
-- 原始SQL
SELECT s.*, c.* FROM students s JOIN choices c ON s.sid = c.sid WHERE age > 18

-- 自动转换为（用户名为 stu002）
SELECT s.*, c.* FROM students s JOIN choices c ON s.sid = c.sid WHERE (age > 18) AND (sid = 'stu002')
```

### 3. 权限拒绝处理
当用户尝试访问没有权限的表时，系统会：
- 抛出 `PermissionDeniedException` 异常
- 返回友好的错误消息
- 记录权限拒绝日志

## 配置文件

权限配置保存在 `config/permissions.yaml` 文件中。

### 配置结构

```yaml
permissions:
  - table: students
    roles:
      - role_pattern: "^admin$"
        allowed_columns: null  # null表示所有列
        row_filter: null       # null表示所有行
        forbidden_columns: []
      
      - role_pattern: "^teach.*"
        allowed_columns: null
        row_filter: null
        forbidden_columns: []
      
      - role_pattern: "^stu.*"
        allowed_columns: null
        row_filter: "sid = '{username}'"  # 使用占位符
        forbidden_columns: []
```

### 配置说明

- **table**: 表名
- **roles**: 角色配置列表
  - **role_pattern**: 角色匹配模式（支持正则表达式）
  - **allowed_columns**: 允许访问的列
    - `null`: 所有列
    - `[]`: 不允许任何列
    - `["col1", "col2"]`: 只允许指定列
  - **row_filter**: 行级过滤条件（SQL WHERE子句）
    - `null`: 所有行
    - `"1=0"`: 不允许任何行
    - `"column = '{username}'"`: 使用占位符，会自动替换为实际用户名
  - **forbidden_columns**: 禁止访问的列（用于数据脱敏）

### 占位符

在 `row_filter` 中可以使用以下占位符：
- `{username}`: 当前用户的用户名
- 更多占位符可以根据需要扩展

## 技术实现

### 1. 权限检查器（PermissionChecker）

位于 `lib/permissions.py`，负责：
- 加载和解析权限配置
- 匹配用户角色
- 转换SQL查询
- 检查列级访问权限

### 2. 数据库连接层集成

在 `tools/agno_tools.py` 的 `DatabaseConnection` 类中：
- 添加了 `set_user_context()` 方法设置用户上下文
- 修改了 `execute_query()` 方法，在执行前进行权限检查和SQL转换
- 返回结果中包含权限警告信息

### 3. Agent层传递用户上下文

- `askdb_agno.py`: 创建Agent时接收 `user_context` 参数
- `backend/agents.py`: AgentManager 管理用户上下文
- `backend/main.py`: API层传递用户信息到Agent

### 4. SQL转换算法

使用字符串处理方法（而非复杂的SQL解析器）：
1. 检测SQL中是否已有WHERE子句
2. 如果有WHERE，在现有条件后添加 `AND (权限条件)`
3. 如果没有WHERE，在合适位置插入 `WHERE (权限条件)`
4. 处理ORDER BY、GROUP BY、LIMIT等子句的位置

## 使用示例

### 在代码中使用

```python
from lib.permissions import get_permission_checker, PermissionDeniedException

# 获取权限检查器
checker = get_permission_checker()

# 检查并转换SQL
try:
    transformed_sql, warnings = checker.check_and_transform_query(
        sql="SELECT * FROM students",
        username="stu001",
        user_type="user"
    )
    print(f"转换后的SQL: {transformed_sql}")
    if warnings:
        print(f"警告: {warnings}")
except PermissionDeniedException as e:
    print(f"权限被拒绝: {e}")
```

### 在API中使用

权限控制已自动集成到所有数据库查询中，无需额外代码。用户通过JWT认证后，其用户信息会自动传递到权限检查器。

## 测试

### 运行测试

```bash
# 基本测试
uv run python test_permissions.py

# 详细的SQL转换测试
uv run python test_permissions_detail.py
```

### 测试覆盖

- ✅ admin用户无限制访问
- ✅ teach用户的表级权限
- ✅ stu用户的行级权限
- ✅ 权限拒绝处理
- ✅ 复杂SQL查询的转换
- ✅ 带WHERE子句的查询
- ✅ JOIN查询的权限控制
- ✅ 列级访问控制
- ✅ 配置重新加载

## 安全特性

### 1. 默认拒绝策略
如果用户不匹配任何权限规则，默认拒绝访问：
```yaml
default_permission:
  allowed_columns: []
  row_filter: "1=0"
  forbidden_columns: null
```

### 2. 日志记录
所有权限检查和SQL转换都会被记录到日志中：
```python
logger.info(f"权限匹配: 用户={username}, 表={table_name}, 行过滤={row_filter}")
logger.info(f"SQL已转换:\n原始: {sql}\n转换后: {transformed_sql}")
```

### 3. 配置热加载
支持在运行时重新加载权限配置，无需重启服务：
```python
from lib.permissions import reload_permissions
reload_permissions()
```

### 4. 多层防护
- SQL执行前的权限检查
- SQL转换确保过滤条件
- 数据库层面的安全检查（SafetyManager）

## 性能考虑

### 1. 配置缓存
权限配置在启动时加载并缓存，避免每次查询都读取文件。

### 2. 简单的SQL转换
使用字符串处理而非复杂的SQL解析器，性能开销极小。

### 3. 正则表达式匹配
角色匹配使用Python的re模块，性能良好。

## 扩展性

### 添加新的权限规则

1. 编辑 `config/permissions.yaml`
2. 添加新的表和角色配置
3. 重新加载配置或重启服务

### 添加新的占位符

在 `lib/permissions.py` 的 `get_table_permissions()` 方法中：
```python
# 替换占位符
if permission["row_filter"]:
    permission["row_filter"] = permission["row_filter"].replace(
        "{username}", username
    )
    # 添加更多占位符
    permission["row_filter"] = permission["row_filter"].replace(
        "{user_id}", str(user_context.get('id', ''))
    )
```

### 支持更复杂的权限逻辑

可以扩展 `PermissionChecker` 类，添加：
- 时间范围限制
- IP地址限制
- 数据量限制
- 字段级脱敏（如手机号、身份证号）

## 最佳实践

### 1. 权限配置
- 使用清晰的角色命名模式
- 为每个表明确定义权限
- 定期审查权限配置

### 2. 测试
- 为每个角色编写测试用例
- 测试边界条件
- 测试复杂SQL查询

### 3. 监控
- 监控权限拒绝日志
- 分析SQL转换日志
- 定期审计访问记录

### 4. 文档
- 记录权限规则的业务逻辑
- 说明特殊权限的原因
- 更新权限变更历史

## 故障排除

### 问题：权限不生效
- 检查用户名是否匹配role_pattern
- 检查配置文件语法是否正确
- 查看日志中的权限匹配信息

### 问题：SQL转换错误
- 检查原始SQL语法
- 查看转换后的SQL
- 测试简化版的SQL

### 问题：性能下降
- 检查权限配置的复杂度
- 优化row_filter条件
- 考虑在数据库层面添加索引

## 依赖

- `pyyaml`: 解析YAML配置文件
- `sqlparse`: SQL解析（可选，当前使用字符串处理）

## 未来改进

1. **字段级脱敏**: 自动脱敏敏感字段（如手机号、身份证）
2. **动态权限**: 支持基于数据内容的动态权限
3. **权限审计**: 完整的权限使用审计日志
4. **可视化配置**: Web界面配置权限规则
5. **性能优化**: SQL转换结果缓存

## 总结

AskDB的权限控制功能提供了：
- ✅ 透明的行级权限控制
- ✅ 灵活的配置管理
- ✅ 完善的安全防护
- ✅ 良好的性能表现
- ✅ 易于扩展和维护

通过外部配置文件管理权限规则，代码与配置分离，便于维护和审计。

