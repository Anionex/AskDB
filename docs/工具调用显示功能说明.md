# 工具调用显示功能说明

## 功能概述

现在AskDB的前端界面会在对话中显示AI agent调用的工具及其参数信息，帮助用户了解AI是如何处理他们的查询的。

## 实现的功能

### 1. 后端工具调用信息提取

**文件**: `backend/main.py`

- 在 `process_chat_message` 函数中，从Agno agent的响应中提取工具调用信息
- 提取的信息包括：
  - 工具名称 (tool name)
  - 调用参数 (arguments)
- 将工具调用信息保存到数据库的metadata字段中，以便历史消息也能显示
- 在API响应中返回 `tool_calls` 字段

### 2. 前端消息数据结构扩展

**文件**: `frontend/src/store/useChatStore.js`

- 扩展消息对象，增加 `toolCalls` 字段
- 在接收AI响应时，保存工具调用信息
- 在加载历史消息时，也能正确处理工具调用信息

### 3. 工具调用展示组件

**文件**: `frontend/src/components/ToolCallsDisplay.jsx`

创建了专门的工具调用展示组件，特性包括：

- **可折叠设计**: 使用Ant Design的Collapse组件，默认折叠，不占用过多空间
- **工具名称中文化**: 将技术性的工具名称映射为用户友好的中文名称
  - `semantic_search_schema` → "语义检索数据库结构"
  - `get_table_ddl` → "获取表结构"
  - `execute_query_with_explanation` → "执行查询"
  - 等等...
- **参数格式化显示**: 
  - 支持JSON对象参数的格式化显示
  - 对长字符串进行截断（超过200字符）
  - 使用代码块样式显示参数值
- **视觉设计**:
  - 使用淡蓝色背景和边框，与系统主题一致
  - 显示工具图标和序号
  - 每个工具调用独立展示，清晰易读

### 4. ChatArea 集成

**文件**: `frontend/src/components/ChatArea.jsx`

- 在AI消息下方自动显示工具调用信息
- 仅在有工具调用时才显示组件
- 与流式Markdown内容协调显示

## 使用效果

当用户发送查询后，AI的回复下方会显示一个可折叠的"调用了 N 个工具"区域：

```
┌─────────────────────────────────────────┐
│ 🤖 AI 回复内容                          │
│                                         │
│ ▼ 调用了 2 个工具                       │
│   ┌─────────────────────────────────┐   │
│   │ 🔧 工具 1: 语义检索数据库结构    │   │
│   │ 调用参数:                        │   │
│   │   query: "用户消费金额"          │   │
│   │   top_k: 5                       │   │
│   └─────────────────────────────────┘   │
│   ┌─────────────────────────────────┐   │
│   │ 🔧 工具 2: 执行查询              │   │
│   │ 调用参数:                        │   │
│   │   sql_query: "SELECT..."         │   │
│   │   explanation: "查询用户总消费"  │   │
│   └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

## 支持的工具

当前已映射的工具包括：

1. **数据库工具**:
   - `semantic_search_schema` - 语义检索数据库结构
   - `get_table_ddl` - 获取表结构
   - `execute_query_with_explanation` - 执行查询
   - `execute_non_query_with_explanation` - 执行修改操作
   - `list_all_tables` - 列出所有表
   - `get_table_info` - 获取表信息

2. **搜索工具**:
   - `duckduckgo_search` - DuckDuckGo搜索
   - `exa_search` - Exa搜索
   - `web_search` - 网络搜索

## 历史消息支持

工具调用信息会被保存到数据库的 `metadata` 字段中，因此：

- 切换会话时，历史消息的工具调用信息也能正确显示
- 刷新页面后，工具调用信息不会丢失
- 所有历史对话都能完整还原当时的工具调用情况

## 技术细节

### 数据流

1. **新消息**:
   ```
   用户输入 → 后端处理 → Agent执行 → 提取tool_calls → 
   保存到DB (metadata) → 返回给前端 → 显示
   ```

2. **历史消息**:
   ```
   切换会话 → 加载历史 → 从metadata提取tool_calls → 显示
   ```

### 数据结构

**工具调用对象**:
```javascript
{
  name: "semantic_search_schema",  // 工具名称
  arguments: {                      // 调用参数
    query: "用户消费",
    top_k: 5
  }
}
```

**消息对象**:
```javascript
{
  id: 123456,
  type: "assistant",
  content: "AI的回复内容...",
  timestamp: "2025-12-28T10:30:00",
  toolCalls: [                      // 新增字段
    { name: "...", arguments: {...} },
    { name: "...", arguments: {...} }
  ]
}
```

## 优势

1. **透明度**: 用户可以清楚看到AI是如何工作的
2. **可调试性**: 开发者可以快速了解工具调用是否正确
3. **教育性**: 帮助用户理解AI的推理过程
4. **不干扰**: 使用折叠设计，不影响正常聊天体验

## 未来扩展

可以考虑的增强功能：

1. 显示工具调用的返回结果
2. 显示工具调用的执行时间
3. 支持工具调用失败的错误信息显示
4. 添加工具调用的统计信息（本次对话共调用了多少次工具）
5. 支持按工具类型筛选和查看

