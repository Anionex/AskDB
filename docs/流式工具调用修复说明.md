# 流式工具调用修复说明

## 问题描述

在实现流式对话后，工具调用信息不再显示。

## 根本原因

根据 Agno 官方文档，要接收工具调用事件，需要同时设置两个参数：
- `stream=True` - 启用流式输出
- **`stream_events=True`** - 启用事件流（关键！）

### Agno 文档说明

```python
# 只会流式返回内容，不会返回工具调用、推理等事件
stream = agent.run("query", stream=True)

# 会返回所有事件，包括内容、工具调用、推理等
stream = agent.run("query", stream=True, stream_events=True)
```

来源：https://docs.agno.com/basics/agents/running-agents

> **Stream All Internal Agent Events**
> 
> Enables comprehensive event streaming to capture all internal agent processes including tool calling, reasoning, and memory updates. Set stream_events=True to receive all RunOutputEvent objects emitted during agent execution, not just response content events.

## 修复方案

### 后端修改（backend/main.py）

**位置**: `process_chat_message_stream` 函数（第 537 行）

#### 修改前（错误）:
```python
# ❌ 只设置 stream=True，无法接收工具调用事件
stream = agent.run(message, stream=True)
```

#### 修改后（正确）:
```python
# ✅ 同时设置 stream=True 和 stream_events=True
stream = agent.run(message, stream=True, stream_events=True)
```

### 事件处理方式

使用 `chunk.event == RunEvent.xxx` 而不是 `isinstance(chunk, XxxEvent)`：

```python
from agno.agent import RunEvent

for chunk in stream:
    if chunk.event == RunEvent.run_content:
        # 内容事件
        content = chunk.content
        
    elif chunk.event == RunEvent.tool_call_started:
        # 工具调用开始
        tool_name = chunk.tool.tool_name
        tool_args = chunk.tool.tool_args
        
    elif chunk.event == RunEvent.tool_call_completed:
        # 工具调用完成
        tool_name = chunk.tool.tool_name
        tool_result = chunk.tool.result
```

## 测试验证

### 测试脚本

```bash
uv run python test_streaming_fix.py
```

### 测试结果

```
[统计]
   - 总事件数: 8
   - 内容块数量: 3
   - 工具调用次数: 1

[工具调用详情]
   1. list_all_tables
      - 参数: {}
      - 有结果: True

[验证]
   [OK] 内容是流式的
   [OK] 工具调用被捕获
   [OK] 所有工具都有结果

[SUCCESS] 流式实现修复成功！
```

✅ **工具调用事件被正确捕获！**

## 事件类型说明

### Agno 流式事件枚举（RunEvent）

| 事件枚举 | 触发时机 | chunk 属性 |
|---------|---------|-----------|
| `RunEvent.run_content` | AI 生成内容时 | `chunk.content` |
| `RunEvent.tool_call_started` | 工具开始调用时 | `chunk.tool.tool_name`, `chunk.tool.tool_args` |
| `RunEvent.tool_call_completed` | 工具执行完成时 | `chunk.tool.tool_name`, `chunk.tool.result` |
| `RunEvent.reasoning_step` | 推理步骤时 | `chunk.reasoning_content` |
| `RunEvent.run_completed` | 运行完成时 | - |

### 前端 SSE 事件映射

| 后端 SSE 事件 | Agno 事件源 | 前端处理 |
|--------------|------------|---------|
| `type: 'content'` | `RunEvent.run_content` | 追加到消息内容 |
| `type: 'tool_call_start'` | `RunEvent.tool_call_started` | 添加工具调用（result=null） |
| `type: 'tool_call_result'` | `RunEvent.tool_call_completed` | 更新工具调用结果 |
| `type: 'done'` | 流结束 | 完成处理 |

## 完整数据流

```
用户发送查询
    ↓
后端: agent.run(message, stream=True, stream_events=True)
    ↓
Agno 生成流式事件
    ↓
├─ RunEvent.tool_call_started
│  └─> SSE: {type: 'tool_call_start', data: {name, arguments}}
│      └─> 前端: 立即显示工具调用
│
├─ RunEvent.tool_call_completed
│  └─> SSE: {type: 'tool_call_result', data: {name, result}}
│      └─> 前端: 更新工具结果
│
└─ RunEvent.run_content (多次)
   └─> SSE: {type: 'content', content: '...'}
       └─> 前端: 逐字显示内容
```

## 关键要点

### ✅ 必须做的

1. **使用 `stream_events=True`**
   ```python
   stream = agent.run(message, stream=True, stream_events=True)
   ```

2. **使用事件枚举检查**
   ```python
   if chunk.event == RunEvent.tool_call_started:
   ```

3. **访问 chunk.tool 属性**
   ```python
   tool_name = chunk.tool.tool_name
   tool_args = chunk.tool.tool_args
   tool_result = chunk.tool.result
   ```

### ❌ 不要做的

1. **只设置 `stream=True`**
   ```python
   # ❌ 这样接收不到工具调用事件
   stream = agent.run(message, stream=True)
   ```

2. **使用 isinstance 检查**
   ```python
   # ❌ 不推荐（虽然也能工作）
   if isinstance(chunk, ToolCallStartedEvent):
   ```

3. **期望自动获取工具调用**
   ```python
   # ❌ 不设置 stream_events=True 就期望有工具调用
   ```

## 性能影响

### stream_events=False（默认）
- ✅ 更快（只返回内容）
- ❌ 无法看到工具调用、推理过程
- 适用场景：只需要最终回复

### stream_events=True
- ✅ 完整透明（所有内部过程）
- ✅ 更好的用户体验
- ⚠️ 略微更多的数据传输
- 适用场景：需要展示 AI 的思考过程

**我们的选择**: `stream_events=True` - 因为用户需要看到工具调用，提高透明度。

## 验收标准

运行测试脚本后，应该看到：

```
[OK] 内容是流式的
[OK] 工具调用被捕获
[OK] 所有工具都有结果
[SUCCESS] 流式实现修复成功！
```

## 前端无需修改

前端代码无需修改，因为：
- 前端已经正确处理 `tool_call_start` 和 `tool_call_result` 事件
- 只是后端之前没有发送这些事件
- 现在后端发送了，前端自动显示

## 总结

**根本问题**: 缺少 `stream_events=True` 参数

**解决方案**: 
```python
agent.run(message, stream=True, stream_events=True)
```

**效果**: 
- ✅ 工具调用实时显示
- ✅ 内容流式输出
- ✅ 完整的用户体验

---

**修复日期**: 2025-12-28  
**关键文档**: https://docs.agno.com/basics/agents/running-agents  
**状态**: ✅ 修复完成并测试通过

