# 工具调用显示功能修复说明

## 问题描述

之前后端 agent 调用工具时，前端不会显示具体调用的工具和调用参数。

## 问题原因

虽然后端的 `process_chat_message` 函数已经正确提取了工具调用信息，但 `ChatResponse` 模型定义中缺少 `tool_calls` 字段，导致 FastAPI 在序列化响应时过滤掉了该字段。

## 修复内容

### 1. 更新 ChatResponse 模型

**文件**: `backend/main.py` (第 174-178 行)

```python
class ChatResponse(BaseModel):
    success: bool
    response: str
    session_id: str
    tool_calls: Optional[List[Dict[str, Any]]] = None  # ✅ 新增字段
```

### 2. 更新 API 响应

**文件**: `backend/main.py` (第 909-915 行)

```python
return ChatResponse(
    success=result["success"],
    response=result["response"],
    session_id=session_id,
    tool_calls=result.get("tool_calls", [])  # ✅ 返回工具调用信息
)
```

## 数据流

### 新消息流程
```
用户输入 
  → 后端 process_chat_message 
  → Agent 执行并返回 response 
  → 从 response.messages 提取 tool_calls 
  → 保存到数据库 metadata 
  → 返回 ChatResponse (包含 tool_calls) 
  → 前端接收并显示
```

### 历史消息流程
```
切换会话 
  → 加载历史消息 
  → 从 metadata 提取 tool_calls 
  → 前端显示
```

## 验证步骤

### 1. 重启后端服务

```bash
# 停止现有后端
# Ctrl+C

# 重新启动
uv run python start_backend.py
```

### 2. 测试新消息

1. 打开前端界面 (http://localhost:5173)
2. 登录系统
3. 发送一个需要查询数据库的问题，例如：
   - "列出所有表"
   - "查询用户数量"
   - "获取订单表的结构"

4. 在 AI 回复下方应该看到：
   ```
   ▼ 调用了 N 个工具
     🔧 工具 1: [工具名称]
     调用参数:
       参数1: 值1
       参数2: 值2
   ```

### 3. 测试历史消息

1. 刷新页面
2. 切换到之前的会话
3. 查看历史消息，工具调用信息应该正确显示

## 工具调用信息格式

### 后端返回格式
```json
{
  "success": true,
  "response": "AI的回复内容...",
  "session_id": "username_1234567890",
  "tool_calls": [
    {
      "name": "semantic_search_schema",
      "arguments": {
        "query": "用户表",
        "top_k": 5
      }
    },
    {
      "name": "execute_query_with_explanation",
      "arguments": {
        "sql_query": "SELECT COUNT(*) FROM users",
        "explanation": "统计用户总数"
      }
    }
  ]
}
```

### 前端显示的工具名称映射

前端会将技术性的工具名称映射为用户友好的中文名称：

| 工具名称 | 显示名称 |
|---------|---------|
| `semantic_search_schema` | 语义检索数据库结构 |
| `get_table_ddl` | 获取表结构 |
| `execute_query_with_explanation` | 执行查询 |
| `execute_non_query_with_explanation` | 执行修改操作 |
| `list_all_tables` | 列出所有表 |
| `get_table_info` | 获取表信息 |
| `duckduckgo_search` | DuckDuckGo搜索 |
| `exa_search` | Exa搜索 |
| `web_search` | 网络搜索 |

## 调试建议

### 如果工具调用仍然不显示

1. **检查后端日志**：
   ```bash
   # 查看是否提取到 tool_calls
   grep "tool_calls" backend.log
   ```

2. **检查浏览器控制台**：
   - 打开开发者工具 (F12)
   - 查看 Network 标签
   - 找到 `/api/protected/chat` 请求
   - 检查响应是否包含 `tool_calls` 字段

3. **检查 Agent 配置**：
   - 确保 agent 创建时正确加载了工具
   - 查看 `askdb_agno.py` 中的工具列表

### 常见问题

**Q: 为什么有些查询不显示工具调用？**

A: 并非所有查询都需要调用工具。例如：
- 简单的问候语不需要工具
- 某些推理任务可能不需要工具
- 只有涉及数据库操作、搜索等任务才会调用工具

**Q: 历史消息的工具调用信息会保留吗？**

A: 是的。工具调用信息保存在数据库的 `metadata` 字段中，即使刷新页面或重启服务器也不会丢失。

**Q: 可以隐藏工具调用显示吗？**

A: 可以。工具调用显示使用了可折叠的设计，默认是折叠的，不会占用太多空间。点击可以展开或折叠。

## 相关文件

- `backend/main.py` - 后端 API 和数据模型
- `frontend/src/components/ToolCallsDisplay.jsx` - 工具调用显示组件
- `frontend/src/components/ChatArea.jsx` - 聊天区域组件
- `frontend/src/store/useChatStore.js` - 前端状态管理
- `backend/conversation_db.py` - 会话数据库管理
- `docs/工具调用显示功能说明.md` - 功能详细说明

## 总结

此次修复解决了 API 响应模型定义不完整的问题，使得工具调用信息能够正确传递到前端并显示。整个数据流已经打通，包括：

✅ 后端提取工具调用信息  
✅ 保存到数据库  
✅ API 响应返回  
✅ 前端接收和显示  
✅ 历史消息支持  

用户现在可以清楚地看到 AI 如何处理他们的查询，提高了系统的透明度和可调试性。








